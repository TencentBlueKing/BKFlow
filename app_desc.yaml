spec_version: 2
app_version: "1.11.1"
app:
  market:
    category: 运维工具
    introduction: 流程引擎服务
    description: 为上层应用提供快捷接入流程引擎服务能力
    display_options:
      width: 800
      height: 600
modules:
  default:
    is_default: True
    language: Python
    scripts:
      pre_release_hook: bin/pre_release.sh
    env_variables:
      - key: BKFLOW_MODULE_TYPE
        value: interface
        description: 模块类型
      - key: GUNICORN_WORKER_NUM
        value: 1
        description: GunicornWorker数量
      - key: GUNICORN_THREAD_NUM
        value: 10
        description: GunicornThread数量
      - key: MEMBER_SELECTOR_DATA_HOST
        value: //open.woa.com/
        description: 人员选择器数据源地址
      - &ENV_BK_APIGW_NETLOC_PATTERN
        key: BK_APIGW_NETLOC_PATTERN
        value: ^(?P<api_name>[\w-]+)\.apigw\.o\.woa\.com
        description: 用于识别请求地址是否来自 APIGW
      - &ENV_BKAPP_USE_PLUGIN_SERVICE
        key: BKAPP_USE_PLUGIN_SERVICE
        value: 1
        description: 是否使用插件服务
      - &DEFAULT_CALLBACK_KEY
        key: BKFLOW_DEFAULT_CALLBACK_KEY
        value: jbSH1_3PFsM8WRZZpUXJPhlJuvuA44A7Ov0nPhFk5ZY=
        description: 默认回调KEY
      - key: BK_APIGW_NAME
        value: &APP_CODE bkflow-eng-svc
        description: APIGW名称
      - key: BK_APIGW_GRANT_APPS
        value: visual-layout
        description: 授权网关接口的app列表
    processes:
      web:
        command: bin/start_web.sh
        plan: 4C2G5R
        replicas: 5
      beat:
        command: celery -A blueapps.core.celery beat -l info
        plan: 4C1G5R
        replicas: 1
      worker:
        command: celery -A blueapps.core.celery worker -n interface_worker@%h -P threads -c 100 -l info
        plan: 4C2G5R
        replicas: 2
    svc_discovery:
      bk_saas:
        - 'bk-user'
        - *APP_CODE
  default-engine:
    language: Python
    scripts:
      pre_release_hook: bin/pre_release.sh
    env_variables:
      - key: BKFLOW_MODULE_TYPE
        value: engine
        description: 模块类型
      - key: BKFLOW_MODULE_CODE
        value: default
        description: 空间编码
      - key: GUNICORN_WORKER_NUM
        value: 2
        description: GunicornWorker数量
      - key: GUNICORN_THREAD_NUM
        value: 10
        description: GunicornThread数量
      - <<: *ENV_BK_APIGW_NETLOC_PATTERN
      - <<: *ENV_BKAPP_USE_PLUGIN_SERVICE
      - <<: *DEFAULT_CALLBACK_KEY
    processes: &default_engine_processes
      er-e:
        command: celery -A blueapps.core.celery worker -P threads -Q er_execute_${BKFLOW_MODULE_CODE} -n er_e_worker@%h -c 100 -l info
        plan: 4C4G5R
        replicas: 5
      er-s:
        command: celery -A blueapps.core.celery worker -P threads -Q er_schedule_${BKFLOW_MODULE_CODE} -n er_s_worker@%h -c 100 -l info
        plan: 4C4G5R
        replicas: 5
      cworker:
        command: python manage.py celery worker -Q celery,pipeline_additional_task,pipeline_additional_task_priority,task_common_${BKFLOW_MODULE_CODE},node_auto_retry_${BKFLOW_MODULE_CODE},timeout_node_execute_${BKFLOW_MODULE_CODE},timeout_node_record_${BKFLOW_MODULE_CODE} -n common_worker@%h -P threads -c 10 -l info
        plan: 4C1G5R
        replicas: 5
      timeout:
        command: python manage.py node_timeout_process
        plan: 4C1G5R
        replicas: 1
      web:
        command: bin/start_web.sh
        plan: 4C2G5R
        replicas: 5
      beat:
        command: celery -A blueapps.core.celery beat -l info
        plan: 4C1G5R
        replicas: 1
      clean-worker:
        command: celery -A blueapps.core.celery worker -P threads -Q clean_task_${BKFLOW_MODULE_CODE} -n clean_worker@%h -c 100 -l info
        plan: 4C4G5R
        replicas: 1
  sap-engine:
    language: Python
    scripts:
      pre_release_hook: bin/pre_release.sh
    env_variables:
      - key: BKFLOW_MODULE_TYPE
        value: engine
        description: 模块类型
      - key: BKFLOW_MODULE_CODE
        value: sap_engine
        description: 空间编码
      - key: GUNICORN_WORKER_NUM
        value: 2
        description: GunicornWorker数量
      - key: GUNICORN_THREAD_NUM
        value: 10
        description: GunicornThread数量
      - <<: *ENV_BK_APIGW_NETLOC_PATTERN
      - <<: *ENV_BKAPP_USE_PLUGIN_SERVICE
      - <<: *DEFAULT_CALLBACK_KEY
    processes: *default_engine_processes
  cloud-pc:
    language: Python
    scripts:
      pre_release_hook: bin/pre_release.sh
    env_variables:
      - key: BKFLOW_MODULE_TYPE
        value: engine
        description: 模块类型
      - key: BKFLOW_MODULE_CODE
        value: cloud_pc_engine
        description: 空间编码
      - key: GUNICORN_WORKER_NUM
        value: 2
        description: GunicornWorker数量
      - key: GUNICORN_THREAD_NUM
        value: 10
        description: GunicornThread数量
      - <<: *ENV_BK_APIGW_NETLOC_PATTERN
      - <<: *ENV_BKAPP_USE_PLUGIN_SERVICE
      - <<: *DEFAULT_CALLBACK_KEY
    processes: *default_engine_processes
  aidev-engine:
    language: Python
    scripts:
      pre_release_hook: bin/pre_release.sh
    env_variables:
      - key: BKFLOW_MODULE_TYPE
        value: engine
        description: 模块类型
      - key: BKFLOW_MODULE_CODE
        value: aidev_engine
        description: 空间编码
      - key: GUNICORN_WORKER_NUM
        value: 2
        description: GunicornWorker数量
      - key: GUNICORN_THREAD_NUM
        value: 10
        description: GunicornThread数量
      - <<: *ENV_BK_APIGW_NETLOC_PATTERN
      - <<: *ENV_BKAPP_USE_PLUGIN_SERVICE
      - <<: *DEFAULT_CALLBACK_KEY
    processes: *default_engine_processes
  bkchat-engine:
    language: Python
    scripts:
      pre_release_hook: bin/pre_release.sh
    env_variables:
      - key: BKFLOW_MODULE_TYPE
        value: engine
        description: 模块类型
      - key: BKFLOW_MODULE_CODE
        value: bkchat_engine
        description: 空间编码
      - key: GUNICORN_WORKER_NUM
        value: 2
        description: GunicornWorker数量
      - key: GUNICORN_THREAD_NUM
        value: 10
        description: GunicornThread数量
      - <<: *ENV_BK_APIGW_NETLOC_PATTERN
      - <<: *ENV_BKAPP_USE_PLUGIN_SERVICE
      - <<: *DEFAULT_CALLBACK_KEY
    processes: *default_engine_processes
